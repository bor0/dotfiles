#!/usr/bin/env php
<?php

if (count($argv) < 3) {
    echo "usage:\n\t{$argv[0]} <folder> <version (7.9.0.0)> [latin (bool)] [flav]\n";
    exit();
}

if (strpos($argv[1], getenv('DEV_BASE')) === FALSE) {
    echo "destination dir is not in dev base. exiting...\n";
    exit();
}

chdir($argv[1]);
exec('sugarrm');

$MANGO_BASE = getenv('MANGO_BASE');

chdir($MANGO_BASE . '/sugarcrm');
exec('composer install');
chdir($MANGO_BASE . '/build/rome/');

$latin = !empty($argv[3]) ? 1 : 0;
$flav = !empty($argv[4]) ? strtolower($argv[4]) : 'ult';

$buildFlags = '--clean=0 --cleanCache=1 --exclude_dirs=node_modules';
$buildFlags .= " --flav=$flav --ver={$argv[2]} --latin=$latin --build_dir={$argv[1]}";

exec("php build.php $buildFlags");

chdir($argv[1]);
exec("mv $flav/sugarcrm/* . && rm -rf $flav");
